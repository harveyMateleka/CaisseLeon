{% extends 'base.html' %}
{% load static %}
{% block style %}

    <link rel="stylesheet" href="{% static 'assets/plugins/select2/css/select2.min.css' %}">

<link rel="stylesheet" href="{% static 'assets/css/bootstrap-datetimepicker.min.css' %}">
<link rel="stylesheet" href="{% static 'assets/css/sweetalert2.min.css' %}">
 <style>

        .delete-btn {
            position: relative;
        }

        .delete {
            display: block;
            color: #dfdfe2;
            text-decoration: none;
            position: absolute;
            background: #EE2D41;
            font-weight: bold;
            padding: 0px 3px;
            border: 1px solid;
            top: -6px;
            left: -6px;
            font-family: Verdana;
            font-size: 12px;
        }

    </style>
{% endblock %}






{% block content %}
{% if request.user.username %}


 <div id="edit_category" class="modal custom-modal fade" role="dialog">
<div class="modal-dialog modal-xl modal-dialog-centered" role="document">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title">Modification Mouvement</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
<div class="modal-body">
<div class="row">
<div class="col-md-12">
<div class="card">
<div class="card-body">
<form action="#" id="frmadd" method="post">


<div class="row">
    <div class="col-md-6">
    <div class="form-group">
    <label>Date:</label>
    <div class="cal-icon">
    <input class="form-control datetimepicker" id="dt" name="dt" type="text">
      </div>
    </div>

    </div>
     <div class="col-md-6">
    <div class="form-group">
    <label>Devise:</label>
   <select class="form-control" name="devise" id="devise">

    <option value="CDF">CDF</option>
    <option value="USD">USD</option>
    <option value="EURO">EURO</option>
    <option value="CFA">CFA</option>


</select>
    <input class="form-control" id="idmvt" name="idmvt" type="hidden">

    </div>

    </div>
</div>
<div class="row">
    <div class="col-md-6">

<div class="form-group">
<label>Nom du Demandeur:</label>
   <input type="text" id="demandeur" readonly required name="demandeur" class="form-control text-uppercase">
</div>
</div>
    <div class="col-md-6">

<div class="form-group">
<label>Signature</label>
  <img id="imgsign"/>
</div>
</div>
</div>
<div class="row">
        <div class="col-md-12">

            <div class="form-group">
            <label>Besoins:</label>
            <textarea rows="5" cols="5" required class="form-control text-uppercase" id="motif" name="motif"></textarea>
            </div>
        </div>
</div>
<hr>

<div class="row">
            <div class="col-md-12">
                <div class="table-responsive">
                    <table class="table table-bordered" style="color:white;">
                        <thead style="background-color: #0d1214;">
                            <tr>
                                <th>Articles</th>
                                <th width="100px">Quantite</th>
                                <th width="150px">P.U</th>
                                <th width="50px">P.T</th>
                            </tr>
                        </thead>
                        <tbody style="background-color: #2f3b49" id="fulldata">


                        <tr style="display: none">
                            <td></td>
                            <td></td>
                            <td class="text-right"><strong>Sub Total</strong></td>
                            <td><span id="subtotal">0.00</span></td>
                        </tr>
                        <tr>

                            <td colspan="3" class="text-right"><strong>Total</strong></td>
                            <td><span id="grandTotal">0</span></td>
                        </tr>
                        <tr style="background-color: #0a7137">
                            <td colspan="4">
                                <button type="submit" class="btn btn-warning" style="color: #2f3b49;font-weight: bold;font-size: 20px;">Modifier</button>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
</form>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>

<div class="page-header" style="margin-top: 0px">
<div class="row">
<div class="col-sm-12">
    <h3 class="page-title">  <span style="float: right;">VALIDATION LISTE DE BESOINS</span></h3>

</div>
</div>
</div>
    <div class="row">
<div class="col-xl-3 col-sm-6 col-12">
<div class="card">
<div class="card-body">
<div class="dash-widget-header">
<span class="dash-widget-icon bg-1">
<i class="fas fa-file-alt"></i>
</span>
<div class="dash-count">
<div class="dash-title">USD</div>
<div class="dash-counts">
<p id="usd"></p>
</div>
</div>
</div>
<div class="progress progress-sm mt-3">
<div class="progress-bar bg-5" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
</div>
</div>
</div>
</div>
<div class="col-xl-3 col-sm-6 col-12">
<div class="card">
<div class="card-body">
<div class="dash-widget-header">
<span class="dash-widget-icon bg-2">
<i class="fas fa-file-alt"></i>
</span>
<div class="dash-count">
<div class="dash-title">EURO</div>
<div class="dash-counts">
<p id="euro"></p>
</div>
</div>
</div>
<div class="progress progress-sm mt-3">
<div class="progress-bar bg-6" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
</div>
</div>
</div>
</div>
<div class="col-xl-3 col-sm-6 col-12">
<div class="card">
<div class="card-body">
<div class="dash-widget-header">
<span class="dash-widget-icon bg-3">
<i class="fas fa-file-alt"></i>
</span>
<div class="dash-count">
<div class="dash-title">CDF</div>
<div class="dash-counts">
<p id="cdf"></p>
</div>
</div>
</div>
<div class="progress progress-sm mt-3">
<div class="progress-bar bg-7" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
</div>
</div>
</div>
</div>
<div class="col-xl-3 col-sm-6 col-12">
<div class="card">
<div class="card-body">
<div class="dash-widget-header">
<span class="dash-widget-icon bg-4">
<i class="fas fa-file-alt"></i>
</span>
<div class="dash-count">
<div class="dash-title">CFA</div>
<div class="dash-counts">
<p id="cfa"></p>
</div>
</div>
</div>
<div class="progress progress-sm mt-3">
<div class="progress-bar bg-8" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
</div>
</div>
</div>
</div>
</div>
<div class="row">
    <div class="col-sm-4">
        <button type="button" id="btnfull" style="color:white" class="btn btn-danger">Tous les Etats besoins</button>
    </div>
</div>
    &nbsp;
<div class="row">
<div class="col-sm-12">
    <div class="card card-table">
    <div class="card-body">

    <div class="table-responsive">
    <table class="table table-center table-hover datatable" id="tablo">
    <thead class="thead-light">
    <tr>
    <th width="50px">#</th>
    <th width="150px">Date</th>
    <th width="200px">Service</th>
    <th width="150px">Demandeur</th>
    <th width="400px">Motif</th>
    <th width="100px">Devise</th>
    <th>Total</th>
    <th class="text-end">Action</th>
    </tr>
    </thead>
    <tbody>
 </tbody>
    </table>
    </div>
    </div>
</div>
</div>
</div>





    {% endif %}



{% endblock %}


{% block script %}

    <script src="{% static 'assets/plugins/select2/js/select2.min.js' %}"></script>
    <script src="{% static 'assets/js/jquery.invoice.js' %}"></script>
    <script src="{% static 'assets/js/sweetalert2.all.min.js' %}"></script>
    <script src="{% static 'assets/plugins/moment/moment.min.js' %}"></script>
    <script src="{% static 'assets/js/bootstrap-datetimepicker.min.js' %}"></script>
    <script src="{% static 'assets/plugins/datatables/datatables.min.js' %}"></script>

{% if request.user.username %}



    <script>

                  $(document).ready(function() {


                    //validation///////////////////////////////////////

                       $('.datatable').DataTable({
                               // "bFilter": false,
                            });

                       $('#btnfull').click(function (e) {
                         e.preventDefault();
                            window.location.href='{% url 'validationfull' %}'


                         });
                        //$('.dataTables_filter').css("display","none");


                      Swal.fire({
                              title: 'Entrez votre Pass',
                              html:'<input type="text" value="{{ request.user.username }}" id="nom" class="swal2-input" placeholder="Nom"><input type="password" id="password" class="swal2-input" placeholder="Password">',
                              confirmButtonText: 'Valider',
                              focusConfirm: false,
                              preConfirm: () => {
                                    const nom = Swal.getPopup().querySelector('#nom').value
                                    const password = Swal.getPopup().querySelector('#password').value
                                    if (!nom || !password) {
                                      Swal.showValidationMessage('Verifier vos champs')
                                    }
                                    return {password: password }
                                  }
                              {#input: 'text',#}
                              {#inputAttributes: {#}
                              {#  autocapitalize: 'on'#}
                              {#},#}
                              {#showCancelButton: true,#}
                              {#confirmButtonText: 'Ok',#}
                            }).then((result) => {
                              if (result.isConfirmed) {

                                  $.ajax({
                                        url: '{% url 'validation' %}',
                                    type: 'POST',
                                     data:{
                                             'pass':result.value.password,
                                             'csrfmiddlewaretoken':'{{ csrf_token }}'
                                     },
                                    async: true,
                                    success: function (data) {

                                            if(data.val=='true'){
                                                 // $('.dataTables_filter').show();
                                            }else{

                                                Swal.fire({
                                          title: data.msg,
                                          confirmButtonText: 'Ok',
                                        }).then((result) => {
                                          if (result.isConfirmed) {
                                           window.location.href='{% url 'check' %}';
                                          }else{
                                              window.location.href='{% url 'check' %}';
                                          }
                                        })

                                            }

                                    },error:function (data) {

                                                             }
                        });


                              }else{
                                  window.location.href='{% url "check" %}'

                              }
                            })
                    //validation///////////////////////////////////////



                      getTot();

                      if($('.datetimepicker').length > 0 ){
                        $('.datetimepicker').datetimepicker({
                            format: 'YYYY-MM-DD',
                            icons: {
                                up: "fas fa-angle-up",
                                down: "fas fa-angle-down",
                                next: 'fas fa-angle-right',
                                previous: 'fas fa-angle-left'
                            }
                        });
	                    }
                                      // Select 2
                      if ($('.select').length > 0) {
                        $('.select').select2({
                            //minimumResultsForSearch: -1,
                            width: '100%'
                        });
                    }

                     $(document).on("click", ".open-delete", function () {
                          $('#idmvt').val($(this).data('idete'));
                         Swal.fire({
                              title: 'Confirmation ?',
                              text: "Voulez-vous vraiment valider cette Opération",
                              icon: 'warning',
                              showCancelButton: true,
                              confirmButtonColor: '#3085d6',
                              cancelButtonColor: '#d33',
                              confirmButtonText: 'Oui',
                              cancelButtonText: 'Annuler',
                            }).then((result) => {
                              if (result.isConfirmed) {
                          $.ajax({
                    url: '{% url 'deletevalidation' %}',
                    type: 'POST',
                     data: {
                        'id': $('#idmvt').val(),
                         'csrfmiddlewaretoken':'{{ csrf_token }}'
                  },
                    async: false,
                    success: function (data) {

                        if(data.id=="0"){
                             Swal.fire({
                                          title: data.msg,
                                          confirmButtonText: 'Ok',
                                        }).then((result) => {
                                          if (result.isConfirmed) {
                                           window.location.href='{% url 'check' %}';
                                          }else{
                                              window.location.href='{% url 'check' %}';
                                          }
                                        })
                        }else{
                            $.toast({
                                    heading: 'Message',
                                    text:data.msg,
                                    position: 'top-right',
                                    loaderBg: '#ff6849',
                                    icon: 'success',
                                    hideAfter: 3500,
                                    stack: 6
                                });

                            $('#idmvt').val('0');
                            affiche();
                              getTot();


                        }




                    },error:function (data) {

                        }
                    });

                          }
                            })


                    });
                     $(document).on("click", ".open-send", function () {
                          $('#idmvt').val($(this).data('idete'));
                         Swal.fire({
                              title: 'Confirmation ?',
                              text: "Voulez-vous vraiment valider cette Opération",
                              icon: 'warning',
                              showCancelButton: true,
                              confirmButtonColor: '#3085d6',
                              cancelButtonColor: '#d33',
                              confirmButtonText: 'Oui',
                              cancelButtonText: 'Annuler',
                            }).then((result) => {
                              if (result.isConfirmed) {

                          $.ajax({
                    url: '{% url 'sendvalidation' %}',
                    type: 'POST',
                     data: {
                        'id': $('#idmvt').val(),
                         'csrfmiddlewaretoken':'{{ csrf_token }}'
                  },
                    async: false,
                    success: function (data) {

                        if(data.id=="0"){
                           Swal.fire({
                                          title: data.msg,
                                          confirmButtonText: 'Ok',
                                        }).then((result) => {
                                          if (result.isConfirmed) {
                                           window.location.href='{% url 'check' %}';
                                          }else{
                                              window.location.href='{% url 'check' %}';
                                          }
                                        })
                        }else{
                            $.toast({
                                    heading: 'Message',
                                    text:data.msg,
                                    position: 'top-right',
                                    loaderBg: '#ff6849',
                                    icon: 'success',
                                    hideAfter: 3500,
                                    stack: 6
                                });

                            $('#idmvt').val('0');
                            affiche();
                              getTot();


                        }




                    },error:function (data) {

                        }
                    });

                          }
                            })


                    });
                     $(document).on("click", ".open-edite", function () {
                              $('#addRow').click();
                              $('#idmvt').val($(this).data('idete'));
                              $('#motif').val($(this).attr('data-motif'));
                              $('#demandeur').val($(this).attr('data-demandeur'));
                              $('#devise').val($(this).attr('data-devise'));
                              $('#dt').val($(this).attr('data-date'));

                              $("#imgsign").attr('src', "data:image/png;base64,"+$(this).attr('data-img'));

                              $(".item-row").remove();
                              getdata($(this).attr('data-idete'));
                             $('#edit_category').click();

                        });




                     {#$('#tablo').on('search.dt',function () {#}
                     {#    var value=$('.dataTables_filter input').val();#}
                     {#    alert(value);#}
                     {#})#}

                     affiche();
                     jQuery().invoice({
                            addRow : "#addRow",
                            delete : ".delete",
                            parentClass : ".item-row",

                            price : ".price",
                            qty : ".qty",
                            total : ".total",
                            totalQty: "#totalQty",

                            subtotal : "#subtotal",
                            discount: "#discount",
                            shipping : "#shipping",
                            grandTotal : "#grandTotal"

                    });





                     $('#frmadd').submit(function (e) {
                             e.preventDefault();

                              Swal.fire({
                                  title: 'Confirmation ?',
                                  text: "Voulez-vous vraiment valider cette Opération",
                                  icon: 'warning',
                                  showCancelButton: true,
                                  confirmButtonColor: '#3085d6',
                                  cancelButtonColor: '#d33',
                                  confirmButtonText: 'Oui',
                                  cancelButtonText: 'Annuler',
                                }).then((result) => {
                                  if (result.isConfirmed) {
                                   var postData = $(this).serializeArray();
                             postData.push({name:'csrfmiddlewaretoken',value:'{{ csrf_token }}' });

                              $('.item').each(function(i, obj) {
                                 postData.push({name:'item',value:$(this).val() });
                             });
                             $('.price').each(function(i, obj) {
                                 postData.push({name:'prix',value:$(this).val() });
                             });
                             $('.qty').each(function(i, obj) {
                                 postData.push({name:'qte',value:$(this).val() });
                             });


                             $.ajax({
                            url: '{% url 'etatbesoin' %}',
                        type: 'POST',
                         data:postData,
                        async: false,
                        success: function (data) {

                            if(data.id=="0"){
                               $.toast({
                                    heading: 'Message',
                                    text: data.msg,
                                    position: 'top-right',
                                    loaderBg: '#ff6849',
                                    icon: 'error',
                                    hideAfter: 3500

                                });
                            }else{

                                Swal.fire({
                                          title: 'Mise à jour Etat Besoins',
                                          confirmButtonText: 'Ok',
                                        }).then((result) => {
                                          $('#idmvt').val('0');
                                          $('#edit_category').click();
                                          affiche();
                                            getTot();
                                        })


                            }




                        },error:function (data) {

                            }
                        });
                                  }
                                })





                         });


                  });
                  function  getTot() {


                            $.ajax({
                            url: '{% url 'getvalidationTot' %}',
                        type: 'GET',
                        async: true,
                        success: function (data) {

                                    $('#usd').html(data.totusd);
                                    $('#cdf').html(data.totcdf);
                                    $('#euro').html(data.toteuro);
                                    $('#cfa').html(data.totcfa);


                        },error:function (data) {

                            }
                        });
                  }
                  function  getdata(id) {


                            $.ajax({
                            url: '{% url 'getvalidation' %}',
                        type: 'GET',
                         data:{
                                'id':id
                         },
                        async: true,
                        success: function (data) {


                                    $('#fulldata').prepend(data)
                                    $('#fulldata').click();
                                 {#$.each(data,function(key,value){#}
                                 {##}
                                 {#     #}
                                 {##}
                                 {#   });#}


                        },error:function (data) {

                            }
                        });
                  }

                   function affiche()
                      {
                      try{
                      tablo=$('#tablo').DataTable({
                        "order":  [[ 0, "desc" ]],
                      "bProcessing":true,
                              "autoWidth":true,
                      "sAjaxSource":"{% url 'getbesoinvalidation' %}",
                      "columns":[
                           {"data":'etatbesoin__id'},
                          {"data":'etatbesoin__datemvt'},
                          {"data":'etatbesoin__superviseur__departement__libelle'},
                          {"data":'etatbesoin__demandeur'},
                          {"data":'etatbesoin__motif',"autoWidth":true,"render":function (data, type, row, meta){

                                        return data;

                                }
                          },
                          {"data":'etatbesoin__devise'},

                          {"data":'multitot'},
                          {"data":'etatbesoin__id',"render":function (data, type, row, meta){

                                return '<a href="#"  data-idete="'+row.etatbesoin__id+'" data-bs-toggle="modal" data-bs-target="#" class="open-send btn btn-sm btn-white text-primary me-2"><i class="far fa-share-square me-1"></i> Valider</a><a href="#"   data-idete="'+row.etatbesoin__id+'" data-motif="'+row.etatbesoin__motif+'" data-demandeur="'+row.etatbesoin__demandeur+'" data-devise="'+row.etatbesoin__devise+'" data-date="'+row.etatbesoin__datemvt+'" data-img="'+row.etatbesoin__superviseur__user__imageuser__imagebs+'" data-bs-toggle="modal" data-bs-target="#edit_category" class="open-edite btn btn-sm btn-white text-success me-2"><i class="far fa-edit me-1"></i> Voir</a><a href="#"   data-idete="'+row.etatbesoin__id+'" data-bs-toggle="modal" data-bs-target="#delete_category" class="open-delete btn btn-sm btn-white text-danger me-2"><i class="far fa-trash-alt me-1"></i>Rejet</a>'


    }}
                      ],
     "createdRow": function (row, data, index) {
                           $(row).find('td:eq(4)').addClass("styletab");

    },

                      "bDestroy":true
                      });

                      }catch(e){}
                      }
    </script>

    {% endif %}
{% endblock %}




